

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Packaging Guide &mdash; Spack 1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'./',
        VERSION:'1.0',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true
      };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
    <link rel="top" title="Spack 1.0 documentation" href="index.html"/>
        <link rel="next" title="Site-specific configuration" href="site_configuration.html"/>
        <link rel="prev" title="Basic usage" href="basic_usage.html"/> 

  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="index.html" class="icon icon-home"> Spack</a>
        <form id ="rtd-search-form" class="wy-form" action="search.html" method="get">
  <input type="text" name="q" placeholder="Search docs" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="features.html">Feature Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="features.html#simple-package-installation">Simple package installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#custom-versions-configurations">Custom versions &amp; configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#customize-dependencies">Customize dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#non-destructive-installs">Non-destructive installs</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#packages-can-peacefully-coexist">Packages can peacefully coexist</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.html#creating-packages-is-easy">Creating packages is easy</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#download">Download</a></li>
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#install">Install</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="basic_usage.html">Basic usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="basic_usage.html#getting-help">Getting Help</a></li>
<li class="toctree-l2"><a class="reference internal" href="basic_usage.html#listing-available-packages">Listing available packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="basic_usage.html#compiler-configuration">Compiler Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="basic_usage.html#installing-and-uninstalling">Installing and uninstalling</a></li>
<li class="toctree-l2"><a class="reference internal" href="basic_usage.html#specs-dependencies">Specs &amp; Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="basic_usage.html#virtual-dependencies">Virtual dependencies</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Packaging Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#package-files">Package Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-packages">Creating Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="#virtual-dependencies">Virtual dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="#abstract-concrete-specs">Abstract &amp; concrete specs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#install-environment">Install environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#patches">Patches</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementing-the-install-method">Implementing the <tt class="docutils literal"><span class="pre">install</span></tt> method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prefix-objects">Prefix objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spec-objects">Spec objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="#shell-command-wrappers">Shell command wrappers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-package-build-process">The package build process</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="site_configuration.html">Site-specific configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="site_configuration.html#mirrors">Mirrors</a></li>
<li class="toctree-l2"><a class="reference internal" href="site_configuration.html#temporary-space">Temporary space</a></li>
<li class="toctree-l2"><a class="reference internal" href="site_configuration.html#concretization-policies">Concretization policies</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="developer_guide.html">Developer Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="developer_guide.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer_guide.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer_guide.html#code-structure">Code Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer_guide.html#spec-objects">Spec objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer_guide.html#package-objects">Package objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer_guide.html#stage-objects">Stage objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer_guide.html#writing-commands">Writing commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer_guide.html#id3">Unit tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer_guide.html#unit-testing">Unit testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer_guide.html#developer-commands">Developer commands</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="package_list.html">Package List</a><ul>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#adept-utils">adept-utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#automaded">automaded</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#boost">boost</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#callpath">callpath</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#clang">clang</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#cmake">cmake</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#cube">cube</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#dtcmp">dtcmp</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#dyninst">dyninst</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#extrae">extrae</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#graphlib">graphlib</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#hdf5">hdf5</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#hwloc">hwloc</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#launchmon">launchmon</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#libarchive">libarchive</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#libcircle">libcircle</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#libdwarf">libdwarf</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#libelf">libelf</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#libevent">libevent</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#libmonitor">libmonitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#libnbc">libNBC</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#libunwind">libunwind</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#llvm">llvm</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#llvm-lld">llvm-lld</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#lwgrp">lwgrp</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#mpich">mpich</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#mpileaks">mpileaks</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#mrnet">mrnet</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#mvapich2">mvapich2</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#ncurses">ncurses</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#netgauge">netgauge</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#ompss">ompss</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#opari2">opari2</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#openmpi">openmpi</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#openssl">openssl</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#otf2">otf2</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#papi">papi</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#paraver">paraver</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#parmetis">parmetis</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#pmgr-collective">pmgr_collective</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#postgresql">postgresql</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#samrai">SAMRAI</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#scalasca">scalasca</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#scorep">scorep</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#scr">scr</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#spindle">spindle</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#sqlite">sqlite</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#stat">stat</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#sundials">sundials</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#swig">swig</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#tau">tau</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#tmux">tmux</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#vim">vim</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#wx">wx</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#wxpropgrid">wxpropgrid</a></li>
<li class="toctree-l2"><a class="reference internal" href="package_list.html#zlib">zlib</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="spack.html">API Docs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="spack.html#subpackages">Subpackages</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#submodules">Submodules</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.architecture">spack.architecture module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.build_environment">spack.build_environment module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.compilation">spack.compilation module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.compiler">spack.compiler module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.concretize">spack.concretize module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.config">spack.config module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.directory_layout">spack.directory_layout module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.error">spack.error module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.mirror">spack.mirror module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.modules">spack.modules module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.multimethod">spack.multimethod module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.package">spack.package module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.packages">spack.packages module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.parse">spack.parse module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.patch">spack.patch module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.relations">spack.relations module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.spec">spack.spec module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.stage">spack.stage module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.url">spack.url module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.version">spack.version module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack.virtual">spack.virtual module</a></li>
<li class="toctree-l2"><a class="reference internal" href="spack.html#module-spack">Module contents</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top">
        <i data-toggle="wy-nav-top" class="icon icon-reorder"></i>
        <a href="index.html">Spack</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <ul class="wy-breadcrumbs">
  <li><a href="index.html">Docs</a> &raquo;</li>
  <li><a href="">Packaging Guide</a></li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="_sources/packaging_guide.txt" rel="nofollow"> View page source</a>
      
    </li>
</ul>
<hr/>

          
  <div class="section" id="packaging-guide">
<span id="id1"></span><h1>Packaging Guide<a class="headerlink" href="#packaging-guide" title="Permalink to this headline">¶</a></h1>
<p>This guide is intended for developers or administrators who want to
<em>package</em> their software so that Spack can install it.  We assume that
you have at least some familiarty with Python, and that you&#8217;ve read
the <a class="reference internal" href="basic_usage.html#basic-usage"><em>basic usage guide</em></a>, especially the part
about <a class="reference internal" href="basic_usage.html#sec-specs"><em>specs</em></a>.</p>
<p>There are two key parts of Spack:</p>
<blockquote>
<div><ol class="arabic simple">
<li><strong>Specs</strong>: expressions for describing builds of software, and</li>
<li><strong>Packages</strong>: Python modules that build software according to a
spec.</li>
</ol>
</div></blockquote>
<p>Package files allow a developer to encapsulate build logic for
different versions, compilers, and platforms in one place.  Specs
allow a user to describe a <em>particular</em> build in a way that a package
author can understand.</p>
<p>Packages in Spack are written in pure Python, so you can do anything
in Spack that you can do in Python.  Python was chosen as the
implementation language for two reasons.  First, Python is getting to
be ubiquitous in the HPC community due to its use in numerical codes.
Second, it&#8217;s a modern language and has many powerful features to help
make package writing easy.</p>
<p>Finally, we&#8217;ve gone to great lengths to make it <em>easy</em> to create
packages.  The <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">create</span></tt> command lets you generate a
boilerplate package template from a tarball URL, and ideally you&#8217;ll
only need to run this once and slightly modify the boilerplate to get
your package working.</p>
<p>This section of the guide goes through the parts of a package, and
then tells you how to make your own.  If you&#8217;re impatient, jump ahead
to <a class="reference internal" href="#spack-create"><em>Creating Packages</em></a>.</p>
<div class="section" id="package-files">
<h2>Package Files<a class="headerlink" href="#package-files" title="Permalink to this headline">¶</a></h2>
<p>It&#8217;s probably easiest to learn about packages by looking at an
example.  Let&#8217;s take a look at the <tt class="docutils literal"><span class="pre">libelf</span></tt> package:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">spack</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">Libelf</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;libelf lets you read, modify or create ELF object files in an</span>
<span class="sd">       architecture-independent way. The library takes care of size</span>
<span class="sd">       and endian issues, e.g. you can process a file for SPARC</span>
<span class="sd">       processors on an Intel-based system.&quot;&quot;&quot;</span>

    <span class="n">homepage</span> <span class="o">=</span> <span class="s">&quot;http://www.mr511.de/software/english.html&quot;</span>
    <span class="n">url</span>      <span class="o">=</span> <span class="s">&quot;http://www.mr511.de/software/libelf-0.8.13.tar.gz&quot;</span>

    <span class="n">version</span><span class="p">(</span><span class="s">&#39;0.8.13&#39;</span><span class="p">,</span> <span class="s">&#39;4136d7b4c04df68b686570afa26988ac&#39;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s">&#39;0.8.12&#39;</span><span class="p">,</span> <span class="s">&#39;e21f8273d9f5f6d43a59878dc274fec7&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="n">configure</span><span class="p">(</span><span class="s">&quot;--prefix=&quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">,</span>
                  <span class="s">&quot;--enable-shared&quot;</span><span class="p">,</span>
                  <span class="s">&quot;--disable-dependency-tracking&quot;</span><span class="p">,</span>
                  <span class="s">&quot;--disable-debug&quot;</span><span class="p">)</span>
        <span class="n">make</span><span class="p">()</span>

        <span class="c"># The mkdir commands in libelf&#39;s install can fail in parallel</span>
        <span class="n">make</span><span class="p">(</span><span class="s">&quot;install&quot;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="directory-structure">
<h3>Directory Structure<a class="headerlink" href="#directory-structure" title="Permalink to this headline">¶</a></h3>
<p>A Spack installation directory is structured like a standard UNIX
install prefix (<tt class="docutils literal"><span class="pre">bin</span></tt>, <tt class="docutils literal"><span class="pre">lib</span></tt>, <tt class="docutils literal"><span class="pre">include</span></tt>, <tt class="docutils literal"><span class="pre">var</span></tt>, <tt class="docutils literal"><span class="pre">opt</span></tt>,
etc.).  Most of the code for Spack lives in <tt class="docutils literal"><span class="pre">$SPACK_ROOT/lib/spack</span></tt>.
Packages themselves live in <tt class="docutils literal"><span class="pre">$SPACK_ROOT/var/spack/packages</span></tt>.</p>
<p>If you <tt class="docutils literal"><span class="pre">cd</span></tt> to that directory, you will see directories for each
package:</p>
<div class="highlight-text"><div class="highlight"><pre>$ cd $SPACK_ROOT/var/spack/packages;  ls
SAMRAI
adept-utils
automaded
boost
callpath
clang
cmake
cube
dtcmp
dyninst
...
</pre></div>
</div>
<p>Each of these directories contains a file called <tt class="docutils literal"><span class="pre">package.py</span></tt>.  This
file is where all the python code for a package goes.  For example,
the <tt class="docutils literal"><span class="pre">libelf</span></tt> package looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre>$SPACK_ROOT/var/spack/packages/
    libelf/
        package.py
</pre></div>
</div>
<p>Alongside the <tt class="docutils literal"><span class="pre">package.py</span></tt> file, a package may contain extra files (like
patches) that it needs to build.</p>
</div>
<div class="section" id="package-names">
<h3>Package Names<a class="headerlink" href="#package-names" title="Permalink to this headline">¶</a></h3>
<p>Packages are named after the directory containing <tt class="docutils literal"><span class="pre">package.py</span></tt>.  So,
<tt class="docutils literal"><span class="pre">libelf</span></tt>&#8216;s <tt class="docutils literal"><span class="pre">package.py</span></tt> lives in a directory called <tt class="docutils literal"><span class="pre">libelf</span></tt>.
The <tt class="docutils literal"><span class="pre">package.py</span></tt> file contains a class called <tt class="docutils literal"><span class="pre">Libelf</span></tt>, which
extends Spack&#8217;s <tt class="docutils literal"><span class="pre">Package</span></tt> class.  This is what makes it a Spack
package.  The <strong>directory name</strong> is what users need to provide on the
command line. e.g., if you type any of these:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="nv">$ </span>spack install libelf
<span class="nv">$ </span>spack install libelf@0.8.13
</pre></div>
</div>
<p>Spack sees the package name in the spec and looks for
<tt class="docutils literal"><span class="pre">libelf/package.py</span></tt> in <tt class="docutils literal"><span class="pre">var/spack/packages</span></tt>.  Likewise, if you say
<tt class="docutils literal"><span class="pre">spack</span> <span class="pre">install</span> <span class="pre">docbook-xml</span></tt>, then Spack looks for
<tt class="docutils literal"><span class="pre">docbook-xml/package.py</span></tt>.</p>
<p>We use the directory name to packagers more freedom when naming their
packages. Package names can contain letters, numbers, dashes, and
underscores.  You can name a package <tt class="docutils literal"><span class="pre">3proxy</span></tt> or <tt class="docutils literal"><span class="pre">_foo</span></tt> and Spack
won&#8217;t care &#8211; it just needs to see that name in the package spec.
These aren&#8217;t valid Python module names, but we allow them in Spack and
import <tt class="docutils literal"><span class="pre">package.py</span></tt> file dynamically.</p>
</div>
<div class="section" id="package-class-names">
<h3>Package class names<a class="headerlink" href="#package-class-names" title="Permalink to this headline">¶</a></h3>
<p>The <strong>class name</strong> (<tt class="docutils literal"><span class="pre">Libelf</span></tt> in our example) is formed by converting
words separated by <cite>-</cite> or <tt class="docutils literal"><span class="pre">_</span></tt> in the file name to camel case.  If
the name starts with a number, we prefix the class name with
<tt class="docutils literal"><span class="pre">_</span></tt>. Here are some examples:</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Module Name</th>
<th class="head">Class Name</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">foo_bar</span></tt></td>
<td><tt class="docutils literal"><span class="pre">FooBar</span></tt></td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">docbook-xml</span></tt></td>
<td><tt class="docutils literal"><span class="pre">DocbookXml</span></tt></td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">FooBar</span></tt></td>
<td><tt class="docutils literal"><span class="pre">Foobar</span></tt></td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">3proxy</span></tt></td>
<td><tt class="docutils literal"><span class="pre">_3proxy</span></tt></td>
</tr>
</tbody>
</table>
<p>The class name is needed by Spack to properly import a package, but
not for much else.  In general, you won&#8217;t have to remember this naming
convention because <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">create</span></tt> will generate a boilerplate class
for you, and you can just fill in the blanks.</p>
</div>
<div class="section" id="metadata">
<span id="id2"></span><h3>Metadata<a class="headerlink" href="#metadata" title="Permalink to this headline">¶</a></h3>
<p>Just under the class name is a description of the <tt class="docutils literal"><span class="pre">libelf</span></tt> package.
In Python, this is called a <em>docstring</em>: a multi-line, triple-quoted
(<tt class="docutils literal"><span class="pre">&quot;&quot;&quot;</span></tt>) string that comes just after the definition of a class.
Spack uses the docstring to generate the description of the package
that is shown when you run <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">info</span></tt>.  If you don&#8217;t provide a
description, Spack will just print &#8220;None&#8221; for the description.</p>
<p>In addition to the package description, there are a few fields you&#8217;ll
need to fill out.  They are as follows:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">homepage</span></tt> (required)</dt>
<dd>This is the URL where you can learn about the package and get
information.  It is displayed to users when they run <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">info</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">url</span></tt> (required)</dt>
<dd>This is the URL where you can download a distribution tarball of
the pacakge&#8217;s source code.</dd>
<dt><tt class="docutils literal"><span class="pre">versions</span></tt> (optional)</dt>
<dd>This is a <a class="reference external" href="http://docs.python.org/2/tutorial/datastructures.html#dictionaries">dictionary</a>
mapping versions to MD5 hashes.  Spack uses the hashes to checksum
archives when it downloads a particular version.</dd>
<dt><tt class="docutils literal"><span class="pre">parallel</span></tt> (optional) Whether make should be parallel by default.</dt>
<dd>By default, this is <tt class="docutils literal"><span class="pre">True</span></tt>, and package authors need to call
<tt class="docutils literal"><span class="pre">make(parallel=False)</span></tt> to override.  If you set this to <tt class="docutils literal"><span class="pre">False</span></tt>
at the package level then each call to <tt class="docutils literal"><span class="pre">make</span></tt> will be sequential
by default, and users will have to call <tt class="docutils literal"><span class="pre">make(parallel=True)</span></tt> to
override it.</dd>
</dl>
<p><tt class="docutils literal"><span class="pre">versions</span></tt> is optional but strongly recommended.  Spack will warn
usrs if they try to install a version (e.g., <tt class="docutils literal"><span class="pre">libelf&#64;0.8.10</span></tt> for
which there is not a checksum available.  They can force it to
download the new version and install, but it&#8217;s better to provide
checksums so users don&#8217;t have to install from an unchecked archive.</p>
</div>
<div class="section" id="install-method">
<h3>Install method<a class="headerlink" href="#install-method" title="Permalink to this headline">¶</a></h3>
<p>The last element of the <tt class="docutils literal"><span class="pre">libelf</span></tt> package is its <tt class="docutils literal"><span class="pre">install()</span></tt>
method.  This is where the real work of installation happens, and
it&#8217;s the main part of the package you&#8217;ll need to customize for each
piece of software.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="n">configure</span><span class="p">(</span><span class="s">&quot;--prefix=&quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">,</span>
                  <span class="s">&quot;--enable-shared&quot;</span><span class="p">,</span>
                  <span class="s">&quot;--disable-dependency-tracking&quot;</span><span class="p">,</span>
                  <span class="s">&quot;--disable-debug&quot;</span><span class="p">)</span>
        <span class="n">make</span><span class="p">()</span>

        <span class="c"># The mkdir commands in libelf&#39;s install can fail in parallel</span>
        <span class="n">make</span><span class="p">(</span><span class="s">&quot;install&quot;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p><tt class="docutils literal"><span class="pre">install</span></tt> takes a <tt class="docutils literal"><span class="pre">spec</span></tt>: a description of how the package should
be built, and a <tt class="docutils literal"><span class="pre">prefix</span></tt>: the path to the directory where the
software should be installed.</p>
<p><a class="reference internal" href="#id8"><em>Writing the install method</em></a> is documented in
detail later, but in general, the <tt class="docutils literal"><span class="pre">install()</span></tt> method should look
familiar.  <tt class="docutils literal"><span class="pre">libelf</span></tt> uses autotools, so the package first calls
<tt class="docutils literal"><span class="pre">configure</span></tt>, passing the prefix and some other package-specific
arguments.  It then calls <tt class="docutils literal"><span class="pre">make</span></tt> and <tt class="docutils literal"><span class="pre">make</span> <span class="pre">install</span></tt>.</p>
<p>Spack provides wrapper functions for <tt class="docutils literal"><span class="pre">configure</span></tt> and <tt class="docutils literal"><span class="pre">make</span></tt> so
that you can call them in a similar way to how you&#8217;d call a shell
comamnd.  In reality, these are Python functions.  Spack provides
these functions to make writing packages more natural. See the section
on <a class="reference internal" href="#shell-wrappers"><em>shell wrappers</em></a>.</p>
</div>
</div>
<div class="section" id="creating-packages">
<span id="spack-create"></span><h2>Creating Packages<a class="headerlink" href="#creating-packages" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3><tt class="docutils literal"><span class="pre">spack</span> <span class="pre">create</span></tt><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">create</span></tt> command takes the tedium out of making packages.
It generates boilerplate code for you, so that you can focus on
getting your package build working.</p>
<p>All you need is the URL to a tarball you want to package:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="nv">$ </span>spack create http://www.cmake.org/files/v2.8/cmake-2.8.12.1.tar.gz
</pre></div>
</div>
<p>When you run this, Spack will look at the tarball URL, and it will try
to figure out the name of the package to be created. It will also try
to figure out what version strings for that package look like.  Once
that is done, it tries to find <em>additional</em> versions by spidering the
package&#8217;s webpage.  Spack then prompts you to tell it how many
versions you want to download and checksum.</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="o">==</span>&gt; Creating template <span class="k">for </span>package <span class="nv">cmake</span>
<span class="o">==</span>&gt; Found 18 versions of cmake.
  2.8.12.1  http://www.cmake.org/files/v2.8/cmake-2.8.12.1.tar.gz
  2.8.12    http://www.cmake.org/files/v2.8/cmake-2.8.12.tar.gz
  2.8.11.2  http://www.cmake.org/files/v2.8/cmake-2.8.11.2.tar.gz
  2.8.11.1  http://www.cmake.org/files/v2.8/cmake-2.8.11.1.tar.gz
  2.8.11    http://www.cmake.org/files/v2.8/cmake-2.8.11.tar.gz
  2.8.10.2  http://www.cmake.org/files/v2.8/cmake-2.8.10.2.tar.gz
  2.8.10.1  http://www.cmake.org/files/v2.8/cmake-2.8.10.1.tar.gz
  2.8.10    http://www.cmake.org/files/v2.8/cmake-2.8.10.tar.gz
  2.8.9     http://www.cmake.org/files/v2.8/cmake-2.8.9.tar.gz
  ...
  2.8.0     http://www.cmake.org/files/v2.8/cmake-2.8.0.tar.gz

Include how many checksums in the package file? <span class="o">(</span>default is 5, q to abort<span class="o">)</span>
</pre></div>
</div>
<p>Spack will automatically download the number of tarballs you specify
(starting with the most recent) and checksum each of them.</p>
<p>Note that you don&#8217;t need to do everything up front.  If your package
is large, you can always choose to download just one tarball for now,
then run <a class="reference internal" href="#spack-checksum"><em>spack checksum</em></a> later if you end up
wanting more.  Let&#8217;s say you chose to download 3 tarballs:</p>
<div class="highlight-sh"><div class="highlight"><pre>Include how many checksums in the package file? <span class="o">(</span>default is 5, q to abort<span class="o">)</span> <span class="nv">3</span>
<span class="o">==</span>&gt; Downloading...
<span class="o">==</span>&gt; Fetching http://www.cmake.org/files/v2.8/cmake-2.8.12.1.tar.gz
<span class="c">######################################################################    98.6%</span>
<span class="o">==</span>&gt; Fetching http://www.cmake.org/files/v2.8/cmake-2.8.12.tar.gz
<span class="c">#####################################################################     96.7%</span>
<span class="o">==</span>&gt; Fetching http://www.cmake.org/files/v2.8/cmake-2.8.11.2.tar.gz
<span class="c">####################################################################      95.2%</span>
</pre></div>
</div>
<p>Now Spack generates boilerplate code and opens the new
<tt class="docutils literal"><span class="pre">package.py</span></tt> file in your favorite <tt class="docutils literal"><span class="pre">$EDITOR</span></tt>:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># FIXME:</span>
<span class="c"># This is a template package file for Spack.  We&#39;ve conveniently</span>
<span class="c"># put &quot;FIXME&quot; labels next to all the things you&#39;ll want to change.</span>
<span class="c">#</span>
<span class="c"># Once you&#39;ve edited all the FIXME&#39;s, delete this whole message,</span>
<span class="c"># save this file, and test out your package like this:</span>
<span class="c">#</span>
<span class="c">#     spack install cmake</span>
<span class="c">#</span>
<span class="c"># You can always get back here to change things with:</span>
<span class="c">#</span>
<span class="c">#     spack edit cmake</span>
<span class="c">#</span>
<span class="c"># See the spack documentation for more information on building</span>
<span class="c"># packages.</span>
<span class="c">#</span>
<span class="kn">from</span> <span class="nn">spack</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">Cmake</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;FIXME: put a proper description of your package here.&quot;&quot;&quot;</span>
    <span class="c"># FIXME: add a proper url for your package&#39;s homepage here.</span>
    <span class="n">homepage</span> <span class="o">=</span> <span class="s">&quot;http://www.example.com&quot;</span>
    <span class="n">url</span>      <span class="o">=</span> <span class="s">&quot;http://www.cmake.org/files/v2.8/cmake-2.8.12.1.tar.gz&quot;</span>

    <span class="n">version</span><span class="p">(</span><span class="s">&#39;2.8.12.1&#39;</span><span class="p">,</span> <span class="s">&#39;9d38cd4e2c94c3cea97d0e2924814acc&#39;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s">&#39;2.8.12&#39;</span><span class="p">,</span>   <span class="s">&#39;105bc6d21cc2e9b6aff901e43c53afea&#39;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s">&#39;2.8.11.2&#39;</span><span class="p">,</span> <span class="s">&#39;6f5d7b8e7534a5d9e1a7664ba63cf882&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="c"># FIXME: Modify the configure line to suit your build system here.</span>
        <span class="n">configure</span><span class="p">(</span><span class="s">&quot;--prefix=&quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">)</span>

        <span class="c"># FIXME: Add logic to build and install here</span>
        <span class="n">make</span><span class="p">()</span>
        <span class="n">make</span><span class="p">(</span><span class="s">&quot;install&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>The tedious stuff (creating the class, checksumming archives) has been
done for you.</p>
<p>All the things you still need to change are marked with <tt class="docutils literal"><span class="pre">FIXME</span></tt>
labels.  The first <tt class="docutils literal"><span class="pre">FIXME</span></tt> refers to the commented instructions at
the top of the file.  You can delete these after reading them.  The
rest of them are as follows:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Add a description in your package&#8217;s docstring.</li>
<li>Change the homepage to a useful URL (not <tt class="docutils literal"><span class="pre">example.com</span></tt>).</li>
<li>Get the <tt class="docutils literal"><span class="pre">install()</span></tt> method working.</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="spack-edit">
<h3><tt class="docutils literal"><span class="pre">spack</span> <span class="pre">edit</span></tt><a class="headerlink" href="#spack-edit" title="Permalink to this headline">¶</a></h3>
<p>Once you&#8217;ve created a package, you can go back and edit it using
<tt class="docutils literal"><span class="pre">spack</span> <span class="pre">edit</span></tt>.  For example, this:</p>
<div class="highlight-sh"><div class="highlight"><pre>spack edit libelf
</pre></div>
</div>
<p>will open <tt class="docutils literal"><span class="pre">$SPACK_ROOT/var/spack/packages/libelf/package.py</span></tt> in
<tt class="docutils literal"><span class="pre">$EDITOR</span></tt>.  If you try to edit a package that doesn&#8217;t exist, Spack
will recommend using <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">create</span></tt>:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="nv">$ </span>spack edit <span class="nv">foo</span>
<span class="o">==</span>&gt; Error: No package <span class="s1">&#39;foo&#39;</span>.  Use spack create, or supply -f/--force to edit a new file.
</pre></div>
</div>
<p>And, finally, if you <em>really</em> want to skip all the automatic stuff
that <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">create</span></tt> does for you, then you can run <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">edit</span>
<span class="pre">-f/--force</span></tt>:</p>
<blockquote>
<div>$ spack edit -f foo</div></blockquote>
<p>Which will generate a minimal package structure for you to fill in:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">spack</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Description&quot;&quot;&quot;</span>

    <span class="n">homepage</span> <span class="o">=</span> <span class="s">&quot;http://www.example.com&quot;</span>
    <span class="n">url</span>      <span class="o">=</span> <span class="s">&quot;http://www.example.com/foo-1.0.tar.gz&quot;</span>

    <span class="n">version</span><span class="p">(</span><span class="s">&#39;1.0&#39;</span><span class="p">,</span> <span class="s">&#39;0123456789abcdef0123456789abcdef&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="n">configure</span><span class="p">(</span><span class="s">&quot;--prefix=&quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="n">make</span><span class="p">()</span>
        <span class="n">make</span><span class="p">(</span><span class="s">&quot;install&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>This is useful when, e.g., Spack cannot figure out the name and
version of your package from the archive URL.</p>
</div>
<div class="section" id="spack-checksum">
<span id="id4"></span><h3><tt class="docutils literal"><span class="pre">spack</span> <span class="pre">checksum</span></tt><a class="headerlink" href="#spack-checksum" title="Permalink to this headline">¶</a></h3>
<p>If you&#8217;ve already created a package and you want to add more version
checksums to it, this is automated with <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">checksum</span></tt>.  Here&#8217;s an
example for <tt class="docutils literal"><span class="pre">libelf</span></tt>:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="nv">$ </span>spack checksum <span class="nv">libelf</span>
<span class="o">==</span>&gt; Found 16 versions of libelf.
  0.8.13    http://www.mr511.de/software/libelf-0.8.13.tar.gz
  0.8.12    http://www.mr511.de/software/libelf-0.8.12.tar.gz
  0.8.11    http://www.mr511.de/software/libelf-0.8.11.tar.gz
  0.8.10    http://www.mr511.de/software/libelf-0.8.10.tar.gz
  0.8.9     http://www.mr511.de/software/libelf-0.8.9.tar.gz
  0.8.8     http://www.mr511.de/software/libelf-0.8.8.tar.gz
  0.8.7     http://www.mr511.de/software/libelf-0.8.7.tar.gz
  0.8.6     http://www.mr511.de/software/libelf-0.8.6.tar.gz
  0.8.5     http://www.mr511.de/software/libelf-0.8.5.tar.gz
  ...
  0.5.2     http://www.mr511.de/software/libelf-0.5.2.tar.gz

How many would you like to checksum? <span class="o">(</span>default is 5, q to abort<span class="o">)</span>
</pre></div>
</div>
<p>This does the same thing that <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">create</span></tt> did, it just allows you
to go back and create more checksums for an existing package.  It
fetches the tarballs you ask for and prints out a dict ready to copy
and paste into your package file:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="o">==</span>&gt; Checksummed new versions of libelf:
    version<span class="o">(</span><span class="s1">&#39;0.8.13&#39;</span>, <span class="s1">&#39;4136d7b4c04df68b686570afa26988ac&#39;</span><span class="o">)</span>
    version<span class="o">(</span><span class="s1">&#39;0.8.12&#39;</span>, <span class="s1">&#39;e21f8273d9f5f6d43a59878dc274fec7&#39;</span><span class="o">)</span>
    version<span class="o">(</span><span class="s1">&#39;0.8.11&#39;</span>, <span class="s1">&#39;e931910b6d100f6caa32239849947fbf&#39;</span><span class="o">)</span>
    version<span class="o">(</span><span class="s1">&#39;0.8.10&#39;</span>, <span class="s1">&#39;9db4d36c283d9790d8fa7df1f4d7b4d9&#39;</span><span class="o">)</span>
</pre></div>
</div>
<p>You should be able to add these checksums directly to the versions
field in your package.</p>
<p>Note that for <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">checksum</span></tt> to work, Spack needs to be able to
<tt class="docutils literal"><span class="pre">import</span></tt> your pacakge in Python.  That means it can&#8217;t have any
syntax errors, or the <tt class="docutils literal"><span class="pre">import</span></tt> will fail.  Use this once you&#8217;ve got
your package in working order.</p>
</div>
<div class="section" id="optional-package-attributes">
<h3>Optional Package Attributes<a class="headerlink" href="#optional-package-attributes" title="Permalink to this headline">¶</a></h3>
<p>In addition to <tt class="docutils literal"><span class="pre">homepage</span></tt>, <tt class="docutils literal"><span class="pre">url</span></tt>, and <tt class="docutils literal"><span class="pre">versions</span></tt>, there are some
other useful attributes you can add to your package file.</p>
<div class="section" id="list-url">
<h4><tt class="docutils literal"><span class="pre">list_url</span></tt><a class="headerlink" href="#list-url" title="Permalink to this headline">¶</a></h4>
<p>When spack tries to find available versions of packages (e.g. in
<tt class="docutils literal"><span class="pre">spack</span> <span class="pre">checksum</span></tt>), by default it looks in the parent directory of
the tarball in the package&#8217;s <tt class="docutils literal"><span class="pre">url</span></tt>.  For example, for libelf, the
url is:</p>
<div class="highlight-python"><div class="highlight"><pre>    <span class="n">url</span>      <span class="o">=</span> <span class="s">&quot;http://www.mr511.de/software/libelf-0.8.13.tar.gz&quot;</span>

    <span class="n">version</span><span class="p">(</span><span class="s">&#39;0.8.13&#39;</span><span class="p">,</span> <span class="s">&#39;4136d7b4c04df68b686570afa26988ac&#39;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s">&#39;0.8.12&#39;</span><span class="p">,</span> <span class="s">&#39;e21f8273d9f5f6d43a59878dc274fec7&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="n">configure</span><span class="p">(</span><span class="s">&quot;--prefix=&quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">,</span>
                  <span class="s">&quot;--enable-shared&quot;</span><span class="p">,</span>
                  <span class="s">&quot;--disable-dependency-tracking&quot;</span><span class="p">,</span>
                  <span class="s">&quot;--disable-debug&quot;</span><span class="p">)</span>
        <span class="n">make</span><span class="p">()</span>

        <span class="c"># The mkdir commands in libelf&#39;s install can fail in parallel</span>
        <span class="n">make</span><span class="p">(</span><span class="s">&quot;install&quot;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Spack will try to fetch the URL <tt class="docutils literal"><span class="pre">http://www.mr511.de/software/</span></tt>,
scrape the page, and use any links that look like the tarball URL to
find other available versions.  For many packages, the tarball&#8217;s
parent directory may be unlistable, or it may not contain any links to
source code archives.  For these, you can specify a separate
<tt class="docutils literal"><span class="pre">list_url</span></tt> indicating the page to search for tarballs.  For example,
<tt class="docutils literal"><span class="pre">libdwarf</span></tt> has the homepage as the <tt class="docutils literal"><span class="pre">list_url</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>    <span class="sd">&quot;&quot;&quot;The DWARF Debugging Information Format is of interest to</span>
<span class="sd">       programmers working on compilers and debuggers (and any one</span>
<span class="sd">       interested in reading or writing DWARF information). It was</span>
<span class="sd">       developed by a committee (known as the PLSIG at the time)</span>
<span class="sd">       starting around 1991. Starting around 1991 SGI developed the</span>
<span class="sd">       libdwarf and dwarfdump tools for internal use and as part of</span>
<span class="sd">       SGI IRIX developer tools. Since that time dwarfdump and</span>
<span class="sd">       libdwarf have been shipped (as an executable and archive</span>
<span class="sd">       respectively, not source) with every release of the SGI</span>
<span class="sd">       MIPS/IRIX C compiler.&quot;&quot;&quot;</span>

    <span class="n">homepage</span> <span class="o">=</span> <span class="s">&quot;http://www.prevanders.net/dwarf.html&quot;</span>
    <span class="n">url</span>      <span class="o">=</span> <span class="s">&quot;http://www.prevanders.net/libdwarf-20130729.tar.gz&quot;</span>
    <span class="n">list_url</span> <span class="o">=</span> <span class="n">homepage</span>

    <span class="n">version</span><span class="p">(</span><span class="s">&#39;20130729&#39;</span><span class="p">,</span> <span class="s">&#39;4cc5e48693f7b93b7aa0261e63c0e21d&#39;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s">&#39;20130207&#39;</span><span class="p">,</span> <span class="s">&#39;64b42692e947d5180e162e46c689dfbf&#39;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s">&#39;20130126&#39;</span><span class="p">,</span> <span class="s">&#39;ded74a5e90edb5a12aac3c29d260c5db&#39;</span><span class="p">)</span>

    <span class="n">depends_on</span><span class="p">(</span><span class="s">&quot;libelf&quot;</span><span class="p">)</span>

    <span class="n">parallel</span> <span class="o">=</span> <span class="bp">False</span>


    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">dwarf_dirs</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">working_dir</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;Makefile&#39;</span><span class="p">):</span>
                    <span class="n">make</span><span class="p">(</span><span class="s">&#39;clean&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="c"># dwarf build does not set arguments for ar properly</span>
        <span class="n">make</span><span class="o">.</span><span class="n">add_default_arg</span><span class="p">(</span><span class="s">&#39;ARFLAGS=rcs&#39;</span><span class="p">)</span>

        <span class="c"># Dwarf doesn&#39;t provide an install, so we have to do it.</span>
        <span class="n">mkdirp</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">,</span> <span class="n">prefix</span><span class="o">.</span><span class="n">include</span><span class="p">,</span> <span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">,</span> <span class="n">prefix</span><span class="o">.</span><span class="n">man1</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">working_dir</span><span class="p">(</span><span class="s">&#39;libdwarf&#39;</span><span class="p">):</span>
            <span class="n">configure</span><span class="p">(</span><span class="s">&quot;--prefix=&quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">,</span> <span class="s">&quot;--enable-shared&quot;</span><span class="p">)</span>
            <span class="n">make</span><span class="p">()</span>

            <span class="n">install</span><span class="p">(</span><span class="s">&#39;libdwarf.a&#39;</span><span class="p">,</span>  <span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">)</span>
            <span class="n">install</span><span class="p">(</span><span class="s">&#39;libdwarf.so&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">)</span>
            <span class="n">install</span><span class="p">(</span><span class="s">&#39;libdwarf.h&#39;</span><span class="p">,</span>  <span class="n">prefix</span><span class="o">.</span><span class="n">include</span><span class="p">)</span>
            <span class="n">install</span><span class="p">(</span><span class="s">&#39;dwarf.h&#39;</span><span class="p">,</span>     <span class="n">prefix</span><span class="o">.</span><span class="n">include</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">working_dir</span><span class="p">(</span><span class="s">&#39;dwarfdump2&#39;</span><span class="p">):</span>
            <span class="n">configure</span><span class="p">(</span><span class="s">&quot;--prefix=&quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">)</span>

            <span class="c"># This makefile has strings of copy commands that</span>
            <span class="c"># cause a race in parallel</span>
            <span class="n">make</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="n">install</span><span class="p">(</span><span class="s">&#39;dwarfdump&#39;</span><span class="p">,</span>      <span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">)</span>
            <span class="n">install</span><span class="p">(</span><span class="s">&#39;dwarfdump.conf&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">)</span>
            <span class="n">install</span><span class="p">(</span><span class="s">&#39;dwarfdump.1&#39;</span><span class="p">,</span>    <span class="n">prefix</span><span class="o">.</span><span class="n">man1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="list-depth">
<h4><tt class="docutils literal"><span class="pre">list_depth</span></tt><a class="headerlink" href="#list-depth" title="Permalink to this headline">¶</a></h4>
<p>Some packages may not have a listing of available verisons on a single
page.  For these, you can specify a <tt class="docutils literal"><span class="pre">list_depth</span></tt> indicating that
Spack should follow links from the <tt class="docutils literal"><span class="pre">list_url</span></tt> up to a particular
depth.  Spack will follow links and search each page reachable from
the <tt class="docutils literal"><span class="pre">list_url</span></tt> for tarball links.  For example, <tt class="docutils literal"><span class="pre">mpich</span></tt> archives
are stored in a directory tree of versions, so the package looks like
this:</p>
<div class="highlight-python"><div class="highlight"><pre>    <span class="n">url</span>      <span class="o">=</span> <span class="s">&quot;http://www.mpich.org/static/downloads/3.0.4/mpich-3.0.4.tar.gz&quot;</span>
    <span class="n">list_url</span>   <span class="o">=</span> <span class="s">&quot;http://www.mpich.org/static/downloads/&quot;</span>
    <span class="n">list_depth</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">version</span><span class="p">(</span><span class="s">&#39;3.0.4&#39;</span><span class="p">,</span> <span class="s">&#39;9c5d5d4fe1e17dd12153f40bc5b6dbc0&#39;</span><span class="p">)</span>

    <span class="n">provides</span><span class="p">(</span><span class="s">&#39;mpi@:3&#39;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s">&#39;@3:&#39;</span><span class="p">)</span>
    <span class="n">provides</span><span class="p">(</span><span class="s">&#39;mpi@:1&#39;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s">&#39;@1:&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="n">config_args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;--prefix=&quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">,</span>
                       <span class="s">&quot;--enable-shared&quot;</span><span class="p">]</span>

        <span class="c"># TODO: Spack should make it so that you can&#39;t actually find</span>
        <span class="c"># these compilers if they&#39;re &quot;disabled&quot; for the current</span>
        <span class="c"># compiler configuration.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">f77</span><span class="p">:</span>
            <span class="n">config_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;--disable-f77&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">fc</span><span class="p">:</span>
            <span class="n">config_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;--disable-fc&quot;</span><span class="p">)</span>

        <span class="n">configure</span><span class="p">(</span><span class="o">*</span><span class="n">config_args</span><span class="p">)</span>
        <span class="n">make</span><span class="p">()</span>
        <span class="n">make</span><span class="p">(</span><span class="s">&quot;install&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filter_compilers</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">filter_compilers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run after install to make the MPI compilers use the</span>
<span class="sd">           compilers that Spack built the package with.</span>

<span class="sd">           If this isn&#39;t done, they&#39;ll have CC, CXX, F77, and FC set</span>
<span class="sd">           to Spack&#39;s generic cc, c++, f77, and f90.  We want them to</span>
<span class="sd">           be bound to whatever compiler they were built with.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span>
        <span class="n">mpicc</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">bin</span><span class="p">,</span> <span class="s">&#39;mpicc&#39;</span><span class="p">)</span>
        <span class="n">mpicxx</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">bin</span><span class="p">,</span> <span class="s">&#39;mpicxx&#39;</span><span class="p">)</span>
        <span class="n">mpif77</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">bin</span><span class="p">,</span> <span class="s">&#39;mpif77&#39;</span><span class="p">)</span>
        <span class="n">mpif90</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">bin</span><span class="p">,</span> <span class="s">&#39;mpif90&#39;</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;ignore_absent&#39;</span> <span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;backup&#39;</span> <span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;string&#39;</span> <span class="p">:</span> <span class="bp">True</span> <span class="p">}</span>
        <span class="n">filter_file</span><span class="p">(</span><span class="s">&#39;CC=&quot;cc&quot;&#39;</span><span class="p">,</span>   <span class="s">&#39;CC=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span>  <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">cc</span><span class="p">,</span>  <span class="n">mpicc</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">filter_file</span><span class="p">(</span><span class="s">&#39;CXX=&quot;c++&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;CXX=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">cxx</span><span class="p">,</span> <span class="n">mpicxx</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">filter_file</span><span class="p">(</span><span class="s">&#39;F77=&quot;f77&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;F77=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">f77</span><span class="p">,</span> <span class="n">mpif77</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">filter_file</span><span class="p">(</span><span class="s">&#39;FC=&quot;f90&quot;&#39;</span><span class="p">,</span>  <span class="s">&#39;FC=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span>  <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">fc</span><span class="p">,</span>  <span class="n">mpif90</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="dependencies">
<span id="id5"></span><h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h2>
<p>We&#8217;ve now covered how to build a simple package, but what if one
package relies on another package to build?  How do you express that
in a package file?  And how do you refer to the other package in the
build script for your own package?</p>
<p>Spack makes this relatively easy.  Let&#8217;s take a look at the
<tt class="docutils literal"><span class="pre">libdwarf</span></tt> package to see how it&#8217;s done:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Libdwarf</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The DWARF Debugging Information Format is of interest to</span>
<span class="sd">       programmers working on compilers and debuggers (and any one</span>
<span class="sd">       interested in reading or writing DWARF information). It was</span>
<span class="sd">       developed by a committee (known as the PLSIG at the time)</span>
<span class="sd">       starting around 1991. Starting around 1991 SGI developed the</span>
<span class="sd">       libdwarf and dwarfdump tools for internal use and as part of</span>
<span class="sd">       SGI IRIX developer tools. Since that time dwarfdump and</span>
<span class="sd">       libdwarf have been shipped (as an executable and archive</span>
<span class="hll"><span class="sd">       respectively, not source) with every release of the SGI</span>
</span><span class="sd">       MIPS/IRIX C compiler.&quot;&quot;&quot;</span>

    <span class="n">homepage</span> <span class="o">=</span> <span class="s">&quot;http://www.prevanders.net/dwarf.html&quot;</span>
    <span class="n">url</span>      <span class="o">=</span> <span class="s">&quot;http://www.prevanders.net/libdwarf-20130729.tar.gz&quot;</span>
    <span class="n">list_url</span> <span class="o">=</span> <span class="n">homepage</span>

    <span class="n">version</span><span class="p">(</span><span class="s">&#39;20130729&#39;</span><span class="p">,</span> <span class="s">&#39;4cc5e48693f7b93b7aa0261e63c0e21d&#39;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s">&#39;20130207&#39;</span><span class="p">,</span> <span class="s">&#39;64b42692e947d5180e162e46c689dfbf&#39;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">(</span><span class="s">&#39;20130126&#39;</span><span class="p">,</span> <span class="s">&#39;ded74a5e90edb5a12aac3c29d260c5db&#39;</span><span class="p">)</span>

    <span class="n">depends_on</span><span class="p">(</span><span class="s">&quot;libelf&quot;</span><span class="p">)</span>

    <span class="n">parallel</span> <span class="o">=</span> <span class="bp">False</span>


<span class="o">...</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="depends-on">
<h3><tt class="docutils literal"><span class="pre">depends_on</span></tt><a class="headerlink" href="#depends-on" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">depends_on('libelf')</span></tt> call on line 10 tells Spack that it needs
to build and install the <tt class="docutils literal"><span class="pre">libelf</span></tt> package before it builds
<tt class="docutils literal"><span class="pre">libdwarf</span></tt>.  This means that in your <tt class="docutils literal"><span class="pre">install()</span></tt> method, you are
guaranteed that <tt class="docutils literal"><span class="pre">libelf</span></tt> has been built and installed successfully,
so you can rely on it for your libdwarf build.</p>
</div>
<div class="section" id="dependency-specs">
<h3>Dependency specs<a class="headerlink" href="#dependency-specs" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">depends_on</span></tt> doesn&#8217;t just take the name of another package.  It
actually takes a full spec.  This means that you can restrict the
versions or other configuration options of <tt class="docutils literal"><span class="pre">libelf</span></tt> that
<tt class="docutils literal"><span class="pre">libdwarf</span></tt> will build with.  Here&#8217;s an example.  Suppose that in the
<tt class="docutils literal"><span class="pre">libdwarf</span></tt> package you wrote:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">depends_on</span><span class="p">(</span><span class="s">&quot;libelf@0.8:&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now <tt class="docutils literal"><span class="pre">libdwarf</span></tt> will only ever build with <tt class="docutils literal"><span class="pre">libelf</span></tt> version <tt class="docutils literal"><span class="pre">0.8</span></tt>
or higher.  If some versions of <tt class="docutils literal"><span class="pre">libelf</span></tt> are installed but they are
all older than this, then Spack will build a new version of <tt class="docutils literal"><span class="pre">libelf</span></tt>
that satisfies the spec&#8217;s version constraint, and it will build
<tt class="docutils literal"><span class="pre">libdwarf</span></tt> with that one.  You could just as easily provide a
version range (e.g., <tt class="docutils literal"><span class="pre">0.8.2:0.8.4</span></tt>) or a variant constraint
(e.g.. <tt class="docutils literal"><span class="pre">+debug</span></tt>) to control how dependencies should be built.</p>
<p>Note that both users and package authors can use the same spec syntax
to refer to different package configurations.  Users use the spec
syntax on the command line to find installed packages or to install
packages with particular constraints, and package authors can use it
to describe relationships between packages.</p>
</div>
</div>
<div class="section" id="virtual-dependencies">
<span id="id6"></span><h2>Virtual dependencies<a class="headerlink" href="#virtual-dependencies" title="Permalink to this headline">¶</a></h2>
<p>In some cases, more than one package can satisfy another package&#8217;s
dependency.  One way this can happen is if a pacakge depends on a
particular <em>interface</em>, but there are multiple <em>implementations</em> of
the interface, and the package could be built with either.  A <em>very</em>
common interface in HPC is the <a class="reference external" href="http://www.mcs.anl.gov/research/projects/mpi/">Message Passing Interface (MPI)</a>, which is used in
many large-scale parallel applications.</p>
<p>MPI has several different implementations (e.g., <a class="reference external" href="http://www.mpich.org">MPICH</a>, <a class="reference external" href="http://www.open-mpi.org">OpenMPI</a>, and
<a class="reference external" href="http://mvapich.cse.ohio-state.edu">MVAPICH</a>) and scientific
applicaitons can be built with any one of these.  Complicating
matters, MPI does not have a standardized ABI, so a package built with
one implementation cannot be relinked with another implementation.
Many pacakage managers handle interfaces like this by requiring many
similar pacakge files, e.g., <tt class="docutils literal"><span class="pre">foo</span></tt>, <tt class="docutils literal"><span class="pre">foo-mvapich</span></tt>, <tt class="docutils literal"><span class="pre">foo-mpich</span></tt>,
but Spack avoids this explosion of package files by providing support
for <em>virtual dependencies</em>.</p>
<div class="section" id="provides">
<h3><tt class="docutils literal"><span class="pre">provides</span></tt><a class="headerlink" href="#provides" title="Permalink to this headline">¶</a></h3>
<p>In Spack, <tt class="docutils literal"><span class="pre">mpi</span></tt> is a <em>virtual package</em>.  A package can depend on it
just like any other package, by supplying a <tt class="docutils literal"><span class="pre">depends_on</span></tt> call in the
package definition.  In <tt class="docutils literal"><span class="pre">mpileaks</span></tt>, this looks like so:</p>
<div class="highlight-python"><div class="highlight"><pre>    <span class="n">version</span><span class="p">(</span><span class="s">&#39;1.0&#39;</span><span class="p">,</span> <span class="s">&#39;8838c574b39202a57d7c2d68692718aa&#39;</span><span class="p">)</span>

    <span class="n">depends_on</span><span class="p">(</span><span class="s">&quot;mpi&quot;</span><span class="p">)</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s">&quot;adept-utils&quot;</span><span class="p">)</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s">&quot;callpath&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, <tt class="docutils literal"><span class="pre">callpath</span></tt> is an actual pacakge, but there is no package file
for <tt class="docutils literal"><span class="pre">mpi</span></tt>, so we say it is a <em>virtual</em> package.  The syntax of
<tt class="docutils literal"><span class="pre">depends_on</span></tt>, however, is the same for both..  If we look inside the
package file of an MPI implementation, say MPICH, we&#8217;ll see something
like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Mpich</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="n">provides</span><span class="p">(</span><span class="s">&#39;mpi&#39;</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">provides(&quot;mpi&quot;)</span></tt> call tells Spack that the <tt class="docutils literal"><span class="pre">mpich</span></tt> package
can be substituted whenever a package says it depends on <tt class="docutils literal"><span class="pre">mpi</span></tt>.</p>
<p>Just as you can pass a spec to <tt class="docutils literal"><span class="pre">depends_on</span></tt>, you can pass a spec to
<tt class="docutils literal"><span class="pre">provides</span></tt> to add constraints.  This allows Spack to support the
notion of <em>versioned interfaces</em>.  The MPI standard has gone through
many revisions, each with new functions added.  Some packages may
require a recent implementation that supports MPI-3 fuctions, but some
MPI versions may only provide up to MPI-2.  You can indicate this by
adding a version constraint to the spec passed to <tt class="docutils literal"><span class="pre">provides</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">provides</span><span class="p">(</span><span class="s">&quot;mpi@:2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Suppose that the above restriction is in the <tt class="docutils literal"><span class="pre">mpich2</span></tt> package.  This
says that <tt class="docutils literal"><span class="pre">mpich2</span></tt> provides MPI support <em>up to</em> version 2, but if a
package <tt class="docutils literal"><span class="pre">depends_on(&quot;mpi&#64;3&quot;)</span></tt>, then Spack will <em>not</em> build with <tt class="docutils literal"><span class="pre">mpich2</span></tt>
for the MPI implementation.</p>
</div>
<div class="section" id="provides-when">
<h3><tt class="docutils literal"><span class="pre">provides</span> <span class="pre">when</span></tt><a class="headerlink" href="#provides-when" title="Permalink to this headline">¶</a></h3>
<p>The same package may provide different versions of an interface
depending on <em>its</em> version.  Above, we simplified the <tt class="docutils literal"><span class="pre">provides</span></tt>
call in <tt class="docutils literal"><span class="pre">mpich</span></tt> to make the explanation easier.  In reality, this is
how <tt class="docutils literal"><span class="pre">mpich</span></tt> declares the virtual packages it provides:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">provides</span><span class="p">(</span><span class="s">&#39;mpi@:3&#39;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s">&#39;@3:&#39;</span><span class="p">)</span>
<span class="n">provides</span><span class="p">(</span><span class="s">&#39;mpi@:1&#39;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s">&#39;@1:&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">when</span></tt> argument to <tt class="docutils literal"><span class="pre">provides</span></tt> (a <a class="reference external" href="http://docs.python.org/2/tutorial/controlflow.html#keyword-arguments">keyword argument</a>
for those not familiar with Python) allows you to specify optional
constraints on the <em>calling</em> package.  The calling package will only
provide the declared virtual spec when <em>it</em> matches the constraints in
the when clause.  Here, when <tt class="docutils literal"><span class="pre">mpich</span></tt> is at version 3 or higher, it
provides MPI up to version 3.  When <tt class="docutils literal"><span class="pre">mpich</span></tt> is at version 1 or higher,
it provides the MPI virtual pacakge at version 1.</p>
<p>The <tt class="docutils literal"><span class="pre">when</span></tt> qualifier will ensure that Spack selects a suitably high
version of <tt class="docutils literal"><span class="pre">mpich</span></tt> to match another package that <tt class="docutils literal"><span class="pre">depends_on</span></tt> a
particular version of MPI.  It will also prevent a user from building
with too low a version of <tt class="docutils literal"><span class="pre">mpich</span></tt>.  For example, suppose the package
<tt class="docutils literal"><span class="pre">foo</span></tt> declares that it <tt class="docutils literal"><span class="pre">depends_on('mpi&#64;2')</span></tt>, and a user invokes
<tt class="docutils literal"><span class="pre">spack</span> <span class="pre">install</span></tt> like this:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="nv">$ </span>spack install foo ^mpich@1.0
</pre></div>
</div>
<p>Spack will fail with a constraint violation, because the version of
MPICH requested is too low for the <tt class="docutils literal"><span class="pre">mpi</span></tt> requirement in <tt class="docutils literal"><span class="pre">foo</span></tt>.</p>
</div>
</div>
<div class="section" id="abstract-concrete-specs">
<span id="abstract-and-concrete"></span><h2>Abstract &amp; concrete specs<a class="headerlink" href="#abstract-concrete-specs" title="Permalink to this headline">¶</a></h2>
<p>Now that we&#8217;ve seen how spec constraints can be specified <a class="reference internal" href="basic_usage.html#sec-specs"><em>on the
command line</em></a> and within package definitions, we can talk
about how Spack puts all of this information together.  When you run
this:</p>
<div class="highlight-sh"><div class="highlight"><pre>spack install mpileaks ^callpath@1.0+debug ^libelf@0.8.11
</pre></div>
</div>
<p>Spack parses the command line and builds a spec from the description.
The spec says that <tt class="docutils literal"><span class="pre">mpileaks</span></tt> should be built with the <tt class="docutils literal"><span class="pre">callpath</span></tt>
library at 1.0 and with the debug option enabled, and with <tt class="docutils literal"><span class="pre">libelf</span></tt>
version 0.8.11.  Spack will also look at the <tt class="docutils literal"><span class="pre">depends_on</span></tt> calls in
all of these packages, and it will build a spec from that.  The specs
from the command line and the specs built from package descriptions
are then combined, and the constraints are checked against each other
to make sure they&#8217;re satisfiable.</p>
<p>What we have after this is done is called an <em>abstract spec</em>.  An
abstract spec is partially specified.  In other words, it could
describe more than one build of a package.  Spack does this to make
things easier on the user: they should only have to specify as much of
the package spec as they care about.  Here&#8217;s an example partial spec
DAG, based on the constraints above:</p>
<div class="highlight-python"><div class="highlight"><pre>mpileaks
    ^callpath@1.0+debug
        ^dyninst
            ^libdwarf
                ^libelf@0.8.11
        ^mpi
</pre></div>
</div>
<p>This diagram shows a spec DAG output as a tree, where successive
levels of indentation represent a depends-on relationship.  In the
above DAG, we can see some packages annotated with their constraints,
and some packages with no annotations at all.  When there are no
annotations, it means the user doesn&#8217;t care what configuration of that
package is built, just so long as it works.</p>
<div class="section" id="concretization">
<h3>Concretization<a class="headerlink" href="#concretization" title="Permalink to this headline">¶</a></h3>
<p>An abstract spec is useful for the user, but you can&#8217;t install an
abstract spec.  Spack has to take the abstract spec and &#8220;fill in&#8221; the
remaining unspecified parts in order to install.  This process is
called <strong>concretization</strong>.  Concretization happens in between the time
the user runs <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">install</span></tt> and the time the <tt class="docutils literal"><span class="pre">install()</span></tt> method
is called.  The concretized version of the spec above might look like
this:</p>
<div class="highlight-python"><div class="highlight"><pre>mpileaks@2.3%gcc@4.7.3=macosx_10.8_x86_64
    ^callpath@1.0%gcc@4.7.3+debug=macosx_10.8_x86_64
        ^dyninst@8.1.2%gcc@4.7.3=macosx_10.8_x86_64
            ^libdwarf@20130729%gcc@4.7.3=macosx_10.8_x86_64
                ^libelf@0.8.11%gcc@4.7.3=macosx_10.8_x86_64
        ^mpich@3.0.4%gcc@4.7.3=macosx_10.8_x86_64
</pre></div>
</div>
<p>Here, all versions, compilers, and platforms are filled in, and there
is a single version (no version ranges) for each package.  All
decisions about configuration have been made, and only after this
point will Spack call the <tt class="docutils literal"><span class="pre">install()</span></tt> method for your package.</p>
<p>Concretization in Spack is based on certain selection policies that
tell Spack how to select, e.g., a version, when one is not specified
explicitly.  Concretization policies are discussed in more detail in
<a class="reference internal" href="site_configuration.html#site-configuration"><em>Site-specific configuration</em></a>.  Sites using Spack can customize them to
match the preferences of their own users.</p>
</div>
<div class="section" id="spack-spec">
<h3><tt class="docutils literal"><span class="pre">spack</span> <span class="pre">spec</span></tt><a class="headerlink" href="#spack-spec" title="Permalink to this headline">¶</a></h3>
<p>For an arbitrary spec, you can see the result of concretization by
running <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">spec</span></tt>.  For example:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="nv">$ </span>spack spec dyninst@8.0.1
dyninst@8.0.1
    ^libdwarf
        ^libelf

dyninst@8.0.1%gcc@4.7.3<span class="o">=</span>macosx_10.8_x86_64
    ^libdwarf@20130729%gcc@4.7.3<span class="o">=</span>macosx_10.8_x86_64
        ^libelf@0.8.13%gcc@4.7.3<span class="o">=</span>macosx_10.8_x86_64
</pre></div>
</div>
</div>
</div>
<div class="section" id="install-environment">
<span id="id7"></span><h2>Install environment<a class="headerlink" href="#install-environment" title="Permalink to this headline">¶</a></h2>
<p>In general, you should not have to do much differently in your install
method than you would when installing a pacakge on the command line.
Spack tries to set environment variables and modify compiler calls so
that it <em>appears</em> to the build system that you&#8217;re building with a
standard system install of everything.  Obviously that&#8217;s not going to
cover <em>all</em> build systems, but it should make it easy to port packages
that use standard build systems to Spack.</p>
<p>There are a couple of things that Spack does that help with this:</p>
<div class="section" id="compiler-interceptors">
<h3>Compiler interceptors<a class="headerlink" href="#compiler-interceptors" title="Permalink to this headline">¶</a></h3>
<p>Spack intercepts the compiler calls that your build makes.  If your
build invokes <tt class="docutils literal"><span class="pre">cc</span></tt>, then Spack intercepts the <tt class="docutils literal"><span class="pre">cc</span></tt> call with its
own wrapper script, and it inserts <tt class="docutils literal"><span class="pre">-I</span></tt>, <tt class="docutils literal"><span class="pre">-L</span></tt>, and <tt class="docutils literal"><span class="pre">-Wl,-rpath</span></tt>
options for all dependencies before invoking the actual compiler.</p>
<p>An example of this would be the <tt class="docutils literal"><span class="pre">libdwarf</span></tt> build, which has one
dependency: <tt class="docutils literal"><span class="pre">libelf</span></tt>.  Every call to <tt class="docutils literal"><span class="pre">cc</span></tt> in the <tt class="docutils literal"><span class="pre">libdwarf</span></tt>
build will have <tt class="docutils literal"><span class="pre">-I$LIBELF_PREFIX/include</span></tt>,
<tt class="docutils literal"><span class="pre">-L$LIBELF_PREFIX/lib</span></tt>, and <tt class="docutils literal"><span class="pre">-Wl,-rpath=$LIBELF_PREFIX/lib</span></tt>
inserted on the command line.  This is done transparently to the
project&#8217;s build system, which will just think it&#8217;s using a system
where <tt class="docutils literal"><span class="pre">libelf</span></tt> is readily available.  Because of this, you <strong>do
not</strong> have to insert extra <tt class="docutils literal"><span class="pre">-I</span></tt>, <tt class="docutils literal"><span class="pre">-L</span></tt>, etc. on the command line.</p>
<p>An exmaple of this is the <tt class="docutils literal"><span class="pre">libdwarf</span></tt> package.  You&#8217;ll notice that it
never mentions <tt class="docutils literal"><span class="pre">libelf</span></tt> outside of the <tt class="docutils literal"><span class="pre">depends_on('libelf')</span></tt>
call, but it still manages to find its dependency library and build.
This is due to Spack&#8217;s compiler interceptors.</p>
</div>
<div class="section" id="environment-variables">
<h3>Environment variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline">¶</a></h3>
<p>Spack sets a number of standard environment variables so that build
systems use its compiler wrappers for their builds.  The standard
enviroment variables are:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="38%" />
<col width="62%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Variable</th>
<th class="head">Purpose</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">CC</span></tt></td>
<td>C compiler</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">CXX</span></tt></td>
<td>C++ compiler</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">F77</span></tt></td>
<td>Fortran 77 compiler</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">FC</span></tt></td>
<td>Fortran 90 and above compiler</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">CMAKE_PREFIX_PATH</span></tt></td>
<td>Path to dependency prefixes for CMake</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>All of these are standard variables respected by most build systems,
so if your project uses something like <tt class="docutils literal"><span class="pre">autotools</span></tt> or <tt class="docutils literal"><span class="pre">CMake</span></tt>,
then it should pick them up automatically when you run <tt class="docutils literal"><span class="pre">configure</span></tt>
or <tt class="docutils literal"><span class="pre">cmake</span></tt> in your <tt class="docutils literal"><span class="pre">install()</span></tt> function.  Many traditional builds
using GNU Make and BSD make also respect these variables, so they may
work with these systems, as well.</p>
<p>If your build systm does <em>not</em> pick these variables up from the
environment automatically, then you can simply pass them on the
command line or use a patch as part of your build process to get the
correct compilers into the project&#8217;s build system.</p>
</div>
<div class="section" id="forked-process">
<h3>Forked process<a class="headerlink" href="#forked-process" title="Permalink to this headline">¶</a></h3>
<p>To give packages free reign over how they install things, how they
modify the environemnt, and how they use Spack&#8217;s internal APIs, we
fork a new process each time we invoke <tt class="docutils literal"><span class="pre">install()</span></tt>.  This allows
packages to have their own completely sandboxed build environment,
without impacting other jobs that the main Spack process runs.</p>
</div>
</div>
<div class="section" id="patches">
<span id="patching"></span><h2>Patches<a class="headerlink" href="#patches" title="Permalink to this headline">¶</a></h2>
<p>Depending on the host architecture, package version, known bugs, or
other issues, you may need to patch your software to get it to build
correctly.  Like many other package systems, spack allows you to store
patches alongside your package files and apply them to source code
after it&#8217;s downloaded.</p>
<div class="section" id="patch">
<h3><tt class="docutils literal"><span class="pre">patch</span></tt><a class="headerlink" href="#patch" title="Permalink to this headline">¶</a></h3>
<p>You can specify patches in your package file with the <tt class="docutils literal"><span class="pre">patch()</span></tt>
function.  <tt class="docutils literal"><span class="pre">patch</span></tt> looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Mvapich2</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">patch</span><span class="p">(</span><span class="s">&#39;ad_lustre_rwcontig_open_source.patch&#39;</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s">&#39;@1.9:&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The first argument can be either a URL or a filename.  It specifies a
patch file that should be applied to your source.  If the patch you
supply is a filename, then the patch needs to live within the spack
source tree.  For example, the patch above lives in a directory
structure like this:</p>
<div class="highlight-python"><div class="highlight"><pre>$SPACK_ROOT/var/spack/packages/
    mvapich2/
        package.py
        ad_lustre_rwcontig_open_source.patch
</pre></div>
</div>
<p>If you supply a URL instead of a filename, the patch will be fetched
from the URL and then applied to your source code.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">It is generally better to use a filename rather than a URL for your
patch.  Patches fetched from URLs are not currently checksummed,
and adding checksums for them is tedious for the package builder.
File patches go into the spack repository, which gives you git&#8217;s
integrity guarantees.  URL patches may be removed in a future spack
version.</p>
</div>
<p><tt class="docutils literal"><span class="pre">patch</span></tt> can take two options keyword arguments.  They are:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">when</span></tt></dt>
<dd>If supplied, this is a spec that tells spack when to apply
the patch.  If the installed package spec matches this spec, the
patch will be applied.  In our example above, the patch is applied
when mvapich is at version <tt class="docutils literal"><span class="pre">1.9</span></tt> or higher.</dd>
<dt><tt class="docutils literal"><span class="pre">level</span></tt></dt>
<dd>This tells spack how to run the <tt class="docutils literal"><span class="pre">patch</span></tt> command.  By default,
the level is 1 and spack runs <tt class="docutils literal"><span class="pre">patch</span> <span class="pre">-p1</span></tt>.  If level is 2,
spack will run <tt class="docutils literal"><span class="pre">patch</span> <span class="pre">-p2</span></tt>, and so on.</dd>
</dl>
<p>A lot of people are confused by level, so here&#8217;s a primer.  If you
look in your patch file, you may see something like this:</p>
<div class="highlight-diff"><div class="highlight"><pre><span class="gd">--- a/src/mpi/romio/adio/ad_lustre/ad_lustre_rwcontig.c 2013-12-10 12:05:44.806417000 -0800</span>
<span class="gi">+++ b/src/mpi/romio/adio/ad_lustre/ad_lustre_rwcontig.c 2013-12-10 11:53:03.295622000 -0800</span>
<span class="gu">@@ -8,7 +8,7 @@</span>
  *   Copyright (C) 2008 Sun Microsystems, Lustre group
  */

<span class="gd">-#define _XOPEN_SOURCE 600</span>
<span class="gi">+//#define _XOPEN_SOURCE 600</span>
 #include &lt;stdlib.h&gt;
 #include &lt;malloc.h&gt;
 #include &quot;ad_lustre.h&quot;
</pre></div>
</div>
<p>The first two lines show paths with synthetic <tt class="docutils literal"><span class="pre">a/</span></tt> and <tt class="docutils literal"><span class="pre">b/</span></tt>
prefixes.  These are placeholders for the two <tt class="docutils literal"><span class="pre">mvapich2</span></tt> source
directories that <tt class="docutils literal"><span class="pre">diff</span></tt> compared when it created the patch file.
This is git&#8217;s default behavior when creating patch files, but other
programs may behave differently.</p>
<p><tt class="docutils literal"><span class="pre">-p1</span></tt> strips off the first level of the prefix in both paths,
allowing the patch to be applied from the root of an expanded mvapich2
archive.  If you set level to <tt class="docutils literal"><span class="pre">2</span></tt>, it would strip off <tt class="docutils literal"><span class="pre">src</span></tt>, and
so on.</p>
<p>It&#8217;s generally easier to just structure your patch file so that it
applies cleanly with <tt class="docutils literal"><span class="pre">-p1</span></tt>, but if you&#8217;re using a URL to a patch you
didn&#8217;t create yourself, <tt class="docutils literal"><span class="pre">level</span></tt> can be handy.</p>
</div>
</div>
<div class="section" id="implementing-the-install-method">
<span id="id8"></span><h2>Implementing the <tt class="docutils literal"><span class="pre">install</span></tt> method<a class="headerlink" href="#implementing-the-install-method" title="Permalink to this headline">¶</a></h2>
<p>Now that the metadata is out of the way, we can move on to the
<tt class="docutils literal"><span class="pre">install()</span></tt> method.  When a user runs <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">install</span></tt>, Spack
fetches an archive for the correct version of the software, expands
the archive, and sets the current working directory to the root
directory of the expanded archive.  It then instantiates a package
object and calls the <tt class="docutils literal"><span class="pre">install()</span></tt> method.</p>
<p>The <tt class="docutils literal"><span class="pre">install()</span></tt> signature looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>The parameters are as follows:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">self</span></tt></dt>
<dd>For those not used to Python instance methods, this is the
package itself.  In this case it&#8217;s an instance of <tt class="docutils literal"><span class="pre">Foo</span></tt>, which
extends <tt class="docutils literal"><span class="pre">Package</span></tt>.  For API docs on Package objects, see
<a class="reference internal" href="spack.html#spack.package.Package" title="spack.package.Package"><tt class="xref py py-class docutils literal"><span class="pre">Package</span></tt></a>.</dd>
<dt><tt class="docutils literal"><span class="pre">spec</span></tt></dt>
<dd>This is the concrete spec object created by Spack from an
abstract spec supplied by the user.  It describes what should be
installed.  It will be of type <a class="reference internal" href="spack.html#spack.spec.Spec" title="spack.spec.Spec"><tt class="xref py py-class docutils literal"><span class="pre">Spec</span></tt></a>.</dd>
<dt><tt class="docutils literal"><span class="pre">prefix</span></tt></dt>
<dd>This is the path that your install method should copy build
targets into.  It acts like a string, but it&#8217;s actually its own
special type, <a class="reference internal" href="spack.util.html#spack.util.prefix.Prefix" title="spack.util.prefix.Prefix"><tt class="xref py py-class docutils literal"><span class="pre">Prefix</span></tt></a>.</dd>
</dl>
<p><tt class="docutils literal"><span class="pre">spec</span></tt> and <tt class="docutils literal"><span class="pre">prefix</span></tt> are passed to <tt class="docutils literal"><span class="pre">install</span></tt> for convenience.
<tt class="docutils literal"><span class="pre">spec</span></tt> is also available as an attribute on the package
(<tt class="docutils literal"><span class="pre">self.spec</span></tt>), and <tt class="docutils literal"><span class="pre">prefix</span></tt> is actually an attribute of <tt class="docutils literal"><span class="pre">spec</span></tt>
(<tt class="docutils literal"><span class="pre">spec.prefix</span></tt>).</p>
<p>As mentioned in <a class="reference internal" href="#install-environment"><em>Install environment</em></a>, you will usually not need
to refer to dependencies explicitly in your package file, as the
compiler wrappers take care of most of the heavy lifting here.  There
will be times, though, when you need to refer to the install locations
of dependencies, or when you need to do something different depending
on the version, compiler, dependencies, etc. that your package is
built with.  These parameters give you access to this type of
information.</p>
</div>
<div class="section" id="prefix-objects">
<span id="id9"></span><h2>Prefix objects<a class="headerlink" href="#prefix-objects" title="Permalink to this headline">¶</a></h2>
<p>Spack passes the <tt class="docutils literal"><span class="pre">prefix</span></tt> parameter to the install method so that
you can pass it to <tt class="docutils literal"><span class="pre">configure</span></tt>, <tt class="docutils literal"><span class="pre">cmake</span></tt>, or some other installer,
e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">configure</span><span class="p">(</span><span class="s">&#39;--prefix=&#39;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">)</span>
</pre></div>
</div>
<p>For the most part, prefix objects behave exactly like strings.  For
packages that do not have their own install target, or for those that
implement it poorly (like <tt class="docutils literal"><span class="pre">libdwarf</span></tt>), you may need to manually copy
things into particular directories under the prefix.  For this, you
can refer to standard subdirectories without having to construct paths
yourself, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="n">mkdirp</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">)</span>
    <span class="n">install</span><span class="p">(</span><span class="s">&#39;foo-tool&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">)</span>

    <span class="n">mkdirp</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">include</span><span class="p">)</span>
    <span class="n">install</span><span class="p">(</span><span class="s">&#39;foo.h&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">.</span><span class="n">include</span><span class="p">)</span>

    <span class="n">mkdirp</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">)</span>
    <span class="n">install</span><span class="p">(</span><span class="s">&#39;libfoo.a&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">.</span><span class="n">lib</span><span class="p">)</span>
</pre></div>
</div>
<p>Most of the standard UNIX directory names are attributes on the
<tt class="docutils literal"><span class="pre">prefix</span></tt> object.  See <tt class="xref py py-class docutils literal"><span class="pre">spack.prefix.Prefix</span></tt> for a full
list.</p>
</div>
<div class="section" id="spec-objects">
<span id="id10"></span><h2>Spec objects<a class="headerlink" href="#spec-objects" title="Permalink to this headline">¶</a></h2>
<p>When <tt class="docutils literal"><span class="pre">install</span></tt> is called, most parts of the build process are set up
for you.  The correct version&#8217;s tarball has been downloaded and
expanded.  Environment variables like <tt class="docutils literal"><span class="pre">CC</span></tt> and <tt class="docutils literal"><span class="pre">CXX</span></tt> are set to
point to the correct compiler and version.  An install prefix has
already been selected and passed in as <tt class="docutils literal"><span class="pre">prefix</span></tt>.  In most cases this
is all you need to get <tt class="docutils literal"><span class="pre">configure</span></tt>, <tt class="docutils literal"><span class="pre">cmake</span></tt>, or another install
working correctly.</p>
<p>There will be times when you need to know more about the build
configuration.  For example, some software requires that you pass
special parameters to <tt class="docutils literal"><span class="pre">configure</span></tt>, like
<tt class="docutils literal"><span class="pre">--with-libelf=/path/to/libelf</span></tt> or <tt class="docutils literal"><span class="pre">--with-mpich</span></tt>.  You might also
need to supply special compiler flags depending on the compiler.  All
of this information is available in the spec.</p>
<div class="section" id="testing-spec-constraints">
<h3>Testing spec constraints<a class="headerlink" href="#testing-spec-constraints" title="Permalink to this headline">¶</a></h3>
<p>You can test whether your spec is configured a certain way by using
the <tt class="docutils literal"><span class="pre">satisfies</span></tt> method.  For example, if you want to check whether
the package&#8217;s version is in a particular range, you can use specs to
do that, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s">&#39;@1.2:1.4&#39;</span><span class="p">):</span>
    <span class="n">configure_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;CXXFLAGS=&#39;-DWITH_FEATURE&#39;&quot;</span><span class="p">)</span>
<span class="n">configure</span><span class="p">(</span><span class="s">&#39;--prefix=&#39;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">,</span> <span class="o">*</span><span class="n">configure_args</span><span class="p">)</span>
</pre></div>
</div>
<p>This works for compilers, too:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%g</span><span class="s">cc&#39;</span><span class="p">):</span>
    <span class="n">configure_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;CXXFLAGS=&quot;-g3 -O3&quot;&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%i</span><span class="s">ntel&#39;</span><span class="p">):</span>
    <span class="n">configure_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;CXXFLAGS=&quot;-xSSE2 -fast&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Or for combinations of spec constraints:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s">&#39;@1.2</span><span class="si">%i</span><span class="s">ntel&#39;</span><span class="p">):</span>
    <span class="n">tty</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Version 1.2 breaks when using Intel compiler!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also do similar satisfaction tests for dependencies:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">satisfies</span><span class="p">(</span><span class="s">&#39;^dyninst@8.0&#39;</span><span class="p">):</span>
    <span class="n">configure_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;CXXFLAGS=-DSPECIAL_DYNINST_FEATURE&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This could allow you to easily work around a bug in a particular
dependency version.</p>
<p>You can use <tt class="docutils literal"><span class="pre">satisfies()</span></tt> to test for particular dependencies,
e.g. <tt class="docutils literal"><span class="pre">foo.satisfies('^openmpi&#64;1.2')</span></tt> or <tt class="docutils literal"><span class="pre">foo.satisfies('^mpich')</span></tt>,
or you can use Python&#8217;s builtin <tt class="docutils literal"><span class="pre">in</span></tt> operator:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="s">&#39;libelf&#39;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;this package depends on libelf&quot;</span>
</pre></div>
</div>
<p>This is useful for virtual dependencies, as you can easily see what
implementation was selected for this build:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="s">&#39;openmpi&#39;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
    <span class="n">configure_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--with-openmpi&#39;</span><span class="p">)</span>
<span class="k">elif</span> <span class="s">&#39;mpich&#39;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
    <span class="n">configure_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--with-mpich&#39;</span><span class="p">)</span>
<span class="k">elif</span> <span class="s">&#39;mvapich&#39;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
    <span class="n">configure_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--with-mvapich&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>It&#8217;s also a bit more concise than satisfies.  The difference between
the two functions is that <tt class="docutils literal"><span class="pre">satisfies()</span></tt> tests whether spec
constraints overlap at all, while <tt class="docutils literal"><span class="pre">in</span></tt> tests whether a spec or any
of its dependencies satisfy the provided spec.</p>
</div>
<div class="section" id="accessing-dependencies">
<h3>Accessing Dependencies<a class="headerlink" href="#accessing-dependencies" title="Permalink to this headline">¶</a></h3>
<p>You may need to get at some file or binary that&#8217;s in the prefix of one
of your dependencies.  You can do that by subscripting the spec:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">my_mpi</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s">&#39;mpich&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>The value in the brackets needs to be some package name, and spec
needs to depend on that package, or the operation will fail.  For
example, the above code will fail if the <tt class="docutils literal"><span class="pre">spec</span></tt> doesn&#8217;t depend on
<tt class="docutils literal"><span class="pre">mpich</span></tt>.  The value returned and assigned to <tt class="docutils literal"><span class="pre">my_mpi</span></tt>, is itself
just another <tt class="docutils literal"><span class="pre">Spec</span></tt> object, so you can do all the same things you
would do with the package&#8217;s own spec:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">mpicc</span> <span class="o">=</span> <span class="n">new_path</span><span class="p">(</span><span class="n">my_mpi</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">bin</span><span class="p">,</span> <span class="s">&#39;mpicc&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="multimethods-and-when">
<span id="multimethods"></span><h3>Multimethods and <tt class="docutils literal"><span class="pre">&#64;when</span></tt><a class="headerlink" href="#multimethods-and-when" title="Permalink to this headline">¶</a></h3>
<p>Spack allows you to make multiple versions of instance functions in
packages, based on whether the package&#8217;s spec satisfies particular
criteria.</p>
<p>The <tt class="docutils literal"><span class="pre">&#64;when</span></tt> annotation lets packages declare multiple versions of
methods like install() that depend on the package&#8217;s spec.  For
example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SomePackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="c"># Do default install</span>

    <span class="nd">@when</span><span class="p">(</span><span class="s">&#39;=chaos_5_x86_64_ib&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="c"># This will be executed instead of the default install if</span>
        <span class="c"># the package&#39;s sys_type() is chaos_5_x86_64_ib.</span>

    <span class="nd">@when</span><span class="p">(</span><span class="s">&#39;=bgqos_0&quot;)</span>
    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="c"># This will be executed if the package&#39;s sys_type is bgqos_0</span>
</pre></div>
</div>
<p>In the above code there are three versions of install(), two of which
are specialized for particular platforms.  The version that is called
depends on the architecture of the package spec.</p>
<p>Note that this works for methods other than install, as well.  So,
if you only have part of the install that is platform specific, you
could do something more like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SomePackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
   <span class="o">...</span>
    <span class="c"># virtual dependence on MPI.</span>
    <span class="c"># could resolve to mpich, mpich2, OpenMPI</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s">&#39;mpi&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># do nothing in the default case</span>
        <span class="k">pass</span>

    <span class="nd">@when</span><span class="p">(</span><span class="s">&#39;^openmpi&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># do something special when this is built with OpenMPI for</span>
        <span class="c"># its MPI implementations.</span>

    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="c"># Do common install stuff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="c"># Do more common install stuff</span>
</pre></div>
</div>
<p>You can write multiple <tt class="docutils literal"><span class="pre">&#64;when</span></tt> specs that satisfy the package&#8217;s spec,
for example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SomePackage</span><span class="p">(</span><span class="n">Package</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">depends_on</span><span class="p">(</span><span class="s">&#39;mpi&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># the default, called when no @when specs match</span>
        <span class="k">pass</span>

    <span class="nd">@when</span><span class="p">(</span><span class="s">&#39;^mpi@3:&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setup_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># this will be called when mpi is version 3 or higher</span>
        <span class="k">pass</span>

    <span class="nd">@when</span><span class="p">(</span><span class="s">&#39;^mpi@2:&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setup_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># this will be called when mpi is version 2 or higher</span>
        <span class="k">pass</span>

    <span class="nd">@when</span><span class="p">(</span><span class="s">&#39;^mpi@1:&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setup_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># this will be called when mpi is version 1 or higher</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>In situations like this, the first matching spec, in declaration order
will be called.  As before, if no <tt class="docutils literal"><span class="pre">&#64;when</span></tt> spec matches, the default
method (the one without the <tt class="docutils literal"><span class="pre">&#64;when</span></tt> decorator) will be called.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The default version of decorated methods must <strong>always</strong> come
first.  Otherwise it will override all of the platform-specific
versions.  There&#8217;s not much we can do to get around this because of
the way decorators work.</p>
</div>
</div>
</div>
<div class="section" id="shell-command-wrappers">
<span id="shell-wrappers"></span><h2>Shell command wrappers<a class="headerlink" href="#shell-command-wrappers" title="Permalink to this headline">¶</a></h2>
<p>Recall the install method from <tt class="docutils literal"><span class="pre">libelf</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="n">configure</span><span class="p">(</span><span class="s">&quot;--prefix=&quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">,</span>
              <span class="s">&quot;--enable-shared&quot;</span><span class="p">,</span>
              <span class="s">&quot;--disable-dependency-tracking&quot;</span><span class="p">,</span>
              <span class="s">&quot;--disable-debug&quot;</span><span class="p">)</span>
    <span class="n">make</span><span class="p">()</span>

    <span class="c"># The mkdir commands in libelf&#39;s install can fail in parallel</span>
    <span class="n">make</span><span class="p">(</span><span class="s">&quot;install&quot;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Normally in Python, you&#8217;d have to write something like this in order
to execute shell commands:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="s">&#39;configure&#39;</span><span class="p">,</span> <span class="s">&#39;--prefix=&#39;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">)</span>
</pre></div>
</div>
<p>We&#8217;ve tried to make this a bit easier by providing callable wrapper
objects for some shell commands.  By default, <tt class="docutils literal"><span class="pre">configure</span></tt>,
<tt class="docutils literal"><span class="pre">cmake</span></tt>, and <tt class="docutils literal"><span class="pre">make</span></tt> wrappers are are provided, so you can call
them more naturally in your package files.</p>
<p>If you need other commands, you can use <tt class="docutils literal"><span class="pre">which</span></tt> to get them:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sed</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s">&#39;sed&#39;</span><span class="p">)</span>
<span class="n">sed</span><span class="p">(</span><span class="s">&#39;s/foo/bar/&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">which</span></tt> function will search the <tt class="docutils literal"><span class="pre">PATH</span></tt> for the application.</p>
<p>Callable wrappers also allow spack to provide some special features.
For example, in Spack, <tt class="docutils literal"><span class="pre">make</span></tt> is parallel by default, and Spack
figures out the number of cores on your machine and passes an
appropriate value for <tt class="docutils literal"><span class="pre">-j&lt;numjobs&gt;</span></tt> when it calls <tt class="docutils literal"><span class="pre">make</span></tt> (see the
<tt class="docutils literal"><span class="pre">parallel</span></tt> package attribute under <a class="reference internal" href="#metadata"><em>metadata</em></a>).  In
a package file, you can supply a keyword argument, <tt class="docutils literal"><span class="pre">parallel=False</span></tt>,
to the <tt class="docutils literal"><span class="pre">make</span></tt> wrapper to disable parallel make.  In the <tt class="docutils literal"><span class="pre">libelf</span></tt>
package, this allows us to avoid race conditions in the library&#8217;s
build system.</p>
</div>
<div class="section" id="the-package-build-process">
<span id="pacakge-lifecycle"></span><h2>The package build process<a class="headerlink" href="#the-package-build-process" title="Permalink to this headline">¶</a></h2>
<p>When you are building packages, you will likely not get things
completely right the first time.</p>
<p>The <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">install</span></tt> command performs a number of tasks before it
finally installs each package.  It downloads an archive, expands it in
a temporary directory, and only then gives control to the package&#8217;s
<tt class="docutils literal"><span class="pre">install()</span></tt> method.  If the build doesn&#8217;t go as planned, you may
want to clean up the temporary directory, or if the package isn&#8217;t
downloading properly, you might want to run <em>only</em> the <tt class="docutils literal"><span class="pre">fetch</span></tt> stage
of the build.</p>
<p>A typical package development cycle might look like this:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="nv">$ </span>spack edit mypackage
<span class="nv">$ </span>spack install mypackage
... build breaks! ...
<span class="nv">$ </span>spack clean mypackage
<span class="nv">$ </span>spack edit mypackage
<span class="nv">$ </span>spack install mypackage
... repeat clean/install <span class="k">until </span>install works ...
</pre></div>
</div>
<p>Below are some commands that will allow you some finer-grained
controll over the install process.</p>
<div class="section" id="spack-fetch">
<h3><tt class="docutils literal"><span class="pre">spack</span> <span class="pre">fetch</span></tt><a class="headerlink" href="#spack-fetch" title="Permalink to this headline">¶</a></h3>
<p>The first step of <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">install</span></tt>.  Takes a spec and determines the
correct download URL to use for the requested package version, then
downloads the archive, checks it against an MD5 checksum, and stores
it in a staging directory if the check was successful.  The staging
directory will be located under <tt class="docutils literal"><span class="pre">$SPACK_HOME/var/spack</span></tt>.</p>
<p>When run after the archive has already been downloaded, <tt class="docutils literal"><span class="pre">spack</span>
<span class="pre">fetch</span></tt> is idempotent and will not download the archive again.</p>
</div>
<div class="section" id="spack-stage">
<h3><tt class="docutils literal"><span class="pre">spack</span> <span class="pre">stage</span></tt><a class="headerlink" href="#spack-stage" title="Permalink to this headline">¶</a></h3>
<p>The second step in <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">install</span></tt> after <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">fetch</span></tt>.  Expands
the downloaded archive in its temporary directory, where it will be
built by <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">install</span></tt>.  Similar to <tt class="docutils literal"><span class="pre">fetch</span></tt>, if the archive has
already been expanded,  <tt class="docutils literal"><span class="pre">stage</span></tt> is idempotent.</p>
</div>
<div class="section" id="spack-patch">
<h3><tt class="docutils literal"><span class="pre">spack</span> <span class="pre">patch</span></tt><a class="headerlink" href="#spack-patch" title="Permalink to this headline">¶</a></h3>
<p>After staging, Spack applies patches to downloaded packages, if any
have been specified in the package file.  This command will run the
install process through the fetch, stage, and patch phases.  Spack
keeps track of whether patches have already been applied and skips
this step if they have been.  If Spack discovers that patches didn&#8217;t
apply cleanly on some previous run, then it will restage the entire
package before patching.</p>
</div>
<div class="section" id="spack-clean">
<h3><tt class="docutils literal"><span class="pre">spack</span> <span class="pre">clean</span></tt><a class="headerlink" href="#spack-clean" title="Permalink to this headline">¶</a></h3>
<p>There are several variations of <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">clean</span></tt>.  With no arguments,
<tt class="docutils literal"><span class="pre">spack</span> <span class="pre">clean</span></tt> runs <tt class="docutils literal"><span class="pre">make</span> <span class="pre">clean</span></tt> in the expanded archive directory.
This is useful if an attempted build failed, and something needs to be
changed to get a package to build.  If a particular package does not
have a <tt class="docutils literal"><span class="pre">make</span> <span class="pre">clean</span></tt> target, this will do nothing.</p>
</div>
<div class="section" id="spack-clean-w-work">
<h3><tt class="docutils literal"><span class="pre">spack</span> <span class="pre">clean</span> <span class="pre">-w</span> <span class="pre">/</span> <span class="pre">--work</span></tt><a class="headerlink" href="#spack-clean-w-work" title="Permalink to this headline">¶</a></h3>
<p>Deletes the entire build directory and re-expands it from the downloaded
archive. This is useful if a package does not support a proper <tt class="docutils literal"><span class="pre">make</span> <span class="pre">clean</span></tt>
target.</p>
</div>
<div class="section" id="spack-clean-d-dist">
<h3><tt class="docutils literal"><span class="pre">spack</span> <span class="pre">clean</span> <span class="pre">-d</span> <span class="pre">/</span> <span class="pre">--dist</span></tt><a class="headerlink" href="#spack-clean-d-dist" title="Permalink to this headline">¶</a></h3>
<p>Deletes the build directory <em>and</em> the downloaded archive.  If
<tt class="docutils literal"><span class="pre">fetch</span></tt>, <tt class="docutils literal"><span class="pre">stage</span></tt>, or <tt class="docutils literal"><span class="pre">install</span></tt> are run again after this, the
process will start from scratch, and the archive archive will be
downloaded again.  Useful if somehow a bad archive is downloaded
accidentally and needs to be cleaned out of the staging area.</p>
</div>
<div class="section" id="spack-purge">
<h3><tt class="docutils literal"><span class="pre">spack</span> <span class="pre">purge</span></tt><a class="headerlink" href="#spack-purge" title="Permalink to this headline">¶</a></h3>
<p>Cleans up <em>everything</em> in the build directory.  You can use this to
recover disk space if temporary files from interrupted or failed
installs accumulate in the staging area.</p>
</div>
<div class="section" id="dirty-installs">
<h3>Dirty Installs<a class="headerlink" href="#dirty-installs" title="Permalink to this headline">¶</a></h3>
<p>By default, <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">install</span></tt> will delete the staging area once a
pacakge has been successfully built and installed, <em>or</em> if an error
occurs during the build.  Use <tt class="docutils literal"><span class="pre">spack</span> <span class="pre">install</span> <span class="pre">--dirty</span></tt> or <tt class="docutils literal"><span class="pre">spack</span>
<span class="pre">install</span> <span class="pre">-d</span></tt> to leave the build directory intact.  This allows you to
inspect the build directory and potentially fix the build.  You can
use <tt class="docutils literal"><span class="pre">purge</span></tt> or <tt class="docutils literal"><span class="pre">clean</span></tt> later to get rid of the unwanted temporary
files.</p>
</div>
</div>
</div>


          <footer>
  
    <div class="rst-footer-buttons">
      
        <a href="site_configuration.html" class="btn btn-neutral float-right" title="Site-specific configuration"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="basic_usage.html" class="btn btn-neutral" title="Basic usage"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <p>
    &copy; Copyright 2013-2014,
    <a href="https://scalability.llnl.gov/">Lawrence Livermore National Laboratory</a>.
    <br/>
    Written by Todd Gamblin, <a href="mailto:tgamblin@llnl.gov">tgamblin@llnl.gov</a>, LLNL-CODE-647188
    <br/>
    Last updated on Oct 08, 2014.
  &nbsp;&nbsp;
  <br/><a href="https://www.github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="http://readthedocs.org">Read the Docs</a>
  </p>
</footer>
        </div>
      </div>

    </section>

  </div>
  

</body>
</html>